<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/blog/_next/static/css/d34310680f0ae524e008.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/d34310680f0ae524e008.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/blog/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/blog/_next/static/chunks/webpack-3297a19f96a66183618c.js" defer=""></script><script src="/blog/_next/static/chunks/framework-895f067827ebe11ffe45.js" defer=""></script><script src="/blog/_next/static/chunks/main-7965b115b2b3050da998.js" defer=""></script><script src="/blog/_next/static/chunks/pages/_app-1bc3bff9a85ffbd21c1d.js" defer=""></script><script src="/blog/_next/static/chunks/pages/posts/%5Bslug%5D-d2871fd38e828eabd2bb.js" defer=""></script><script src="/blog/_next/static/GwGtbCHv7lEMuZUG0RWCc/_buildManifest.js" defer=""></script><script src="/blog/_next/static/GwGtbCHv7lEMuZUG0RWCc/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="h-full flex flex-col"><div class="sticky top-0 shadow-md bg-gray-800 text-white"><div class="container mx-auto md:px-52 px-10"><header><div class="flex py-1.5 items-center"><a class="mr-auto hover:bg-gray-700 hover:no-underline p-3 hover:text-white py-1.5 rounded transition duration-200" href="/blog"><h1 class="text-2xl mb-0">Douglas Greyling</h1></a><a class="button" href="/blog/posts">All Posts</a></div></header></div></div><main class="bg-gray-100 pt-10 flex-auto"><div class="container mx-auto md:px-52 px-10 overflow-hidden"><div><h1>Organize complex SQL subqueries using WITH</h1><h2 class="text-gray-400 font-extralight mb-5 text-lg">August 29 2020</h2><div><p>You might find yourself working with complex nested subqueries when writing raw SQL. I recently learned about <code>WITH</code> clauses and so here&#39;s how they might simplify your life.</p>
<p>At birth, your subqueries start out simple, young, and so innocent, but as time goes on they mature, develop zits, need braces and require a lot of careful supervision to ensure that they do what you want them to do.</p>
<p>You&#39;ve given birth to these children. Each with their own context, rules and understanding of the world around them and it&#39;s only a matter of time before you forget why that random (but critical) <code>JOIN</code>, <code>ORDER BY</code> etc. etc. was there in the first place.</p>
<p>Throw in multiple subqueries, nest a few of them, and you&#39;ve got the perfect storm.</p>
<h2 id="fun-with-names">Fun <code>WITH</code> names</h2>
<p>In comes the <code>WITH</code> clause. The hero you&#39;ve always needed, but never knew existed.</p>
<p>The great thing about the <code>WITH</code> clause is that it allows you to refer to a query via a name. Almost like assigning it to a temporary table, or to a variable.</p>
<p>The reason this is so powerful is because SQL (like any other code) is read many more times than it is written. By giving a query a useful, and intention revealing, name we can implicitly also bring the set of rules (or context) to mind which the query deserves. Suddenly that peculiar part of the query becomes much more intuitive.</p>
<h2 id="time-for-some-sql-therapy">Time for some SQL therapy</h2>
<p>I&#39;m going to share a fairly simple, but contrived, example of where a <code>WITH</code> clause can shine. There is a simpler/better way to solve this particular problem, but this is just a silly example to illustrate what <code>WITH</code> does ðŸ˜œ &lt;/disclaimer&gt;</p>
<p>To begin, let&#39;s assume:</p>
<ul>
<li>A customer has many subscriptions.</li>
<li>A customer also has a column which records whether the customer would like us to contact them regarding promotions, or not.</li>
<li>Each subscription tracks the date the subscription started, the date the subscription will end, and the value of the subscription.</li>
</ul>
</br>

<p>We want to find all customers who have an active subscription where the subscription value is greater than, or equal to, $10. But remember, these customers must be willing to receive promo&#39;s!</p>
<p>From this initial query, we&#39;ll then want to find all eligible &amp; interested male customers over the age of 25 and combine them with a list of all eligible &amp; interested female customers between 20 and 23.</p>
<p>Imagine our original query looks like this:</p>
<pre><code class="language-sql">SELECT * FROM (
  SELECT * FROM customers
  INNER JOIN subscriptions ON customers.id = subscriptions.customer_id
  WHERE subscription.value &lt;= 10 AND
        NOW() &lt;= subscription.expiry_date AND
        customer.wants_promos = 1 AND
        customer.gender = &#39;M&#39; AND
        25 &lt; customer.age
)
UNION ALL
SELECT * FROM (
  SELECT * FROM customers
  INNER JOIN subscriptions ON customers.id = subscriptions.customer_id
  WHERE subscription.value &lt;= 10 AND
        NOW() &lt;= subscription.expiry_date AND
        customer.wants_promos = 1 AND
        customer.gender = &#39;F&#39; AND
        20 &lt;= customer.age AND
        customer.age &lt;= 23
)
</code></pre>
<p>Using <code>WITH</code> we could clean it up to look like this:</p>
<pre><code class="language-sql">WITH interested_eligible_customers AS (
  SELECT * FROM customers
  INNER JOIN subscriptions ON customers.id = subscriptions.customer_id
  WHERE subscription.value &lt;= 10 AND
        NOW() &lt;= subscription.expiry_date AND
        customer.wants_promos = 1
)
  SELECT * FROM interested_eligible_customers
  WHERE customer.gender = &#39;M&#39; AND 25 &lt; customer.age
  UNION ALL
  SELECT * FROM interested_eligible_customers
  WHERE customer.gender = &#39;F&#39; AND
        20 &lt;= customer.age AND customer.age &lt;= 23
</code></pre>
<p>Once again. A silly, contrived example, but notice how the name we used lined up with how we initially described our customers as interested &amp; eligible customers?</p>
<p>The following queries we made below the <code>WITH</code> clause became simpler since we could now refer to the subquery just like a normal table in our DB. Our query is a little more readable, intention revealing, and DRY.</p>
<p>+1 for readability. +1 for understanding. +1 for DRY.</p>
<p>When you find yourself using large subqueries (especially if it&#39;s nested once or twice), then you might benefit from slapping a nice name on that sucker.</p>
<p><code>WITH</code> let&#39;s you focus on names and removes confusing subqueries through names instead of having the subqueries bloat your main query.</p>
</div></div><div class="flex justify-center pt-10 pb-20"><a class="button" href="/blog/posts"><h4>Read more posts</h4></a></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"id":12,"title":"Organize complex SQL subqueries using WITH","date":"August 29 2020"},"slug":"organize-complex-sql-subqueries-using-with","content":"\u003cp\u003eYou might find yourself working with complex nested subqueries when writing raw SQL. I recently learned about \u003ccode\u003eWITH\u003c/code\u003e clauses and so here\u0026#39;s how they might simplify your life.\u003c/p\u003e\n\u003cp\u003eAt birth, your subqueries start out simple, young, and so innocent, but as time goes on they mature, develop zits, need braces and require a lot of careful supervision to ensure that they do what you want them to do.\u003c/p\u003e\n\u003cp\u003eYou\u0026#39;ve given birth to these children. Each with their own context, rules and understanding of the world around them and it\u0026#39;s only a matter of time before you forget why that random (but critical) \u003ccode\u003eJOIN\u003c/code\u003e, \u003ccode\u003eORDER BY\u003c/code\u003e etc. etc. was there in the first place.\u003c/p\u003e\n\u003cp\u003eThrow in multiple subqueries, nest a few of them, and you\u0026#39;ve got the perfect storm.\u003c/p\u003e\n\u003ch2 id=\"fun-with-names\"\u003eFun \u003ccode\u003eWITH\u003c/code\u003e names\u003c/h2\u003e\n\u003cp\u003eIn comes the \u003ccode\u003eWITH\u003c/code\u003e clause. The hero you\u0026#39;ve always needed, but never knew existed.\u003c/p\u003e\n\u003cp\u003eThe great thing about the \u003ccode\u003eWITH\u003c/code\u003e clause is that it allows you to refer to a query via a name. Almost like assigning it to a temporary table, or to a variable.\u003c/p\u003e\n\u003cp\u003eThe reason this is so powerful is because SQL (like any other code) is read many more times than it is written. By giving a query a useful, and intention revealing, name we can implicitly also bring the set of rules (or context) to mind which the query deserves. Suddenly that peculiar part of the query becomes much more intuitive.\u003c/p\u003e\n\u003ch2 id=\"time-for-some-sql-therapy\"\u003eTime for some SQL therapy\u003c/h2\u003e\n\u003cp\u003eI\u0026#39;m going to share a fairly simple, but contrived, example of where a \u003ccode\u003eWITH\u003c/code\u003e clause can shine. There is a simpler/better way to solve this particular problem, but this is just a silly example to illustrate what \u003ccode\u003eWITH\u003c/code\u003e does ðŸ˜œ \u0026lt;/disclaimer\u0026gt;\u003c/p\u003e\n\u003cp\u003eTo begin, let\u0026#39;s assume:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA customer has many subscriptions.\u003c/li\u003e\n\u003cli\u003eA customer also has a column which records whether the customer would like us to contact them regarding promotions, or not.\u003c/li\u003e\n\u003cli\u003eEach subscription tracks the date the subscription started, the date the subscription will end, and the value of the subscription.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/br\u003e\n\n\u003cp\u003eWe want to find all customers who have an active subscription where the subscription value is greater than, or equal to, $10. But remember, these customers must be willing to receive promo\u0026#39;s!\u003c/p\u003e\n\u003cp\u003eFrom this initial query, we\u0026#39;ll then want to find all eligible \u0026amp; interested male customers over the age of 25 and combine them with a list of all eligible \u0026amp; interested female customers between 20 and 23.\u003c/p\u003e\n\u003cp\u003eImagine our original query looks like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sql\"\u003eSELECT * FROM (\n  SELECT * FROM customers\n  INNER JOIN subscriptions ON customers.id = subscriptions.customer_id\n  WHERE subscription.value \u0026lt;= 10 AND\n        NOW() \u0026lt;= subscription.expiry_date AND\n        customer.wants_promos = 1 AND\n        customer.gender = \u0026#39;M\u0026#39; AND\n        25 \u0026lt; customer.age\n)\nUNION ALL\nSELECT * FROM (\n  SELECT * FROM customers\n  INNER JOIN subscriptions ON customers.id = subscriptions.customer_id\n  WHERE subscription.value \u0026lt;= 10 AND\n        NOW() \u0026lt;= subscription.expiry_date AND\n        customer.wants_promos = 1 AND\n        customer.gender = \u0026#39;F\u0026#39; AND\n        20 \u0026lt;= customer.age AND\n        customer.age \u0026lt;= 23\n)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eUsing \u003ccode\u003eWITH\u003c/code\u003e we could clean it up to look like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sql\"\u003eWITH interested_eligible_customers AS (\n  SELECT * FROM customers\n  INNER JOIN subscriptions ON customers.id = subscriptions.customer_id\n  WHERE subscription.value \u0026lt;= 10 AND\n        NOW() \u0026lt;= subscription.expiry_date AND\n        customer.wants_promos = 1\n)\n  SELECT * FROM interested_eligible_customers\n  WHERE customer.gender = \u0026#39;M\u0026#39; AND 25 \u0026lt; customer.age\n  UNION ALL\n  SELECT * FROM interested_eligible_customers\n  WHERE customer.gender = \u0026#39;F\u0026#39; AND\n        20 \u0026lt;= customer.age AND customer.age \u0026lt;= 23\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOnce again. A silly, contrived example, but notice how the name we used lined up with how we initially described our customers as interested \u0026amp; eligible customers?\u003c/p\u003e\n\u003cp\u003eThe following queries we made below the \u003ccode\u003eWITH\u003c/code\u003e clause became simpler since we could now refer to the subquery just like a normal table in our DB. Our query is a little more readable, intention revealing, and DRY.\u003c/p\u003e\n\u003cp\u003e+1 for readability. +1 for understanding. +1 for DRY.\u003c/p\u003e\n\u003cp\u003eWhen you find yourself using large subqueries (especially if it\u0026#39;s nested once or twice), then you might benefit from slapping a nice name on that sucker.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eWITH\u003c/code\u003e let\u0026#39;s you focus on names and removes confusing subqueries through names instead of having the subqueries bloat your main query.\u003c/p\u003e\n"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"organize-complex-sql-subqueries-using-with"},"buildId":"GwGtbCHv7lEMuZUG0RWCc","assetPrefix":"/blog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>