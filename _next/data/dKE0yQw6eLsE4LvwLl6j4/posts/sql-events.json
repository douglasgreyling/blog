{"pageProps":{"frontmatter":{"id":8,"title":"SQL Events","date":"May 21 2020"},"slug":"sql-events","content":"<p>An event in SQL is task, or block, of SQL code which gets executed based on a schedule. We can use it in situations where we’d like to automate the maintenance of db data, like deleting stale audit data (at least in this example). This post continues on from #7, so be sure to read that one if you haven’t.</p>\n<p>To start we need to turn the event scheduler on. This is the variable which tells our db to enable this kind of feature.</p>\n<p>We can try find it by doing something like this:</p>\n<pre><code class=\"language-sql\">SHOW VARIABLES LIKE ‘event%’;\n</code></pre>\n<p>We should see the variable name, and its value which will either be <code>ON</code> or <code>OFF</code>. We need it to be on and we can turn it on like this:</p>\n<pre><code class=\"language-sql\">SET GLOBAL event_scheduler = ON;\n</code></pre>\n<h2 id=\"creating-an-event\">Creating an event</h2>\n<p>Let’s create our first event:</p>\n<pre><code class=\"language-sql\">DELIMITER $$\n\nCREATE EVENT yearly_delete_stale_audit_rows\nON SCHEDULE\n    EVERY 1 YEAR STARTS ‘2020-01-01’ ENDS ‘2022-01-01’\nDO BEGIN\n    DELETE FROM post_audits\n    WHERE date &lt; NOW() – INTERVAL 1 YEAR;\nEND $$\n\nDELIMITER ;\n</code></pre>\n<p>And just like that we’ve created an event, given it a name which describes when its gonna kick in. Events can either be a once off type thing and we can do that by replacing <code>ON SCHEDULE</code> with <code>USE AT ‘2020-01-01’</code> which will only run this event on that date.</p>\n<p>In this case, we’d like to make it run on a schedule where it starts on ‘2020-01-01’ and it should end on ‘2022-01-01’, although the <code>STARTS</code> and <code>END</code> keywords are completely optional.</p>\n<h2 id=\"viewing-events\">Viewing events</h2>\n<p>We can view our events like this:</p>\n<pre><code class=\"language-sql\">SHOW EVENTS;\n</code></pre>\n<p>And don’t forget that we can also append <code>LIKE</code> to filter down results if we need to.</p>\n<h2 id=\"dropping-events\">Dropping events</h2>\n<p>Like most things we can delete them when we don’t want them anymore.</p>\n<pre><code class=\"language-sql\">DROP EVENT yearly_delete_stale_audit_rows;\n</code></pre>\n<h2 id=\"altering-events\">Altering events</h2>\n<p>But what about when we want to change or disable or events?</p>\n<p>To change an event, use <code>ALTER EVENT</code>:</p>\n<pre><code class=\"language-sql\">DELIMITER $$\n\nALTER EVENT yearly_delete_stale_audit_rows\nON SCHEDULE\n    EVERY 1 YEAR STARTS ‘2019-01-01’ ENDS ‘2029-01-01’\nDO BEGIN\n    DELETE FROM post_audits\n    WHERE action_date &lt; NOW() – INTERVAL 2 YEAR;\nEND $$\n\nDELIMITER ;\n</code></pre>\n<p>But that might be heavy handed, when all we want to do is temporarily disable an event like so:</p>\n<pre><code class=\"language-sql\">ALTER EVENT yearly_delete_stale_audit_rows DISABLE;\n</code></pre>\n<p>We can later replace <code>DISABLE</code> with <code>ENABLE</code> when we want to turn it back on!</p>\n<p>And just like that we have an event which cleans up our stale audit data!</p>\n"},"__N_SSG":true}